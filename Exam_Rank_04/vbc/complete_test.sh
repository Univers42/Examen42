#!/bin/bash

gcc -Wall -Wextra -Werror complete_vbc.c -o vbc 2>&1 || { echo "Compilation failed!"; exit 1; }

G='\033[0;32m' R='\033[0;31m' NC='\033[0m'
P=0 F=0

c() {
    local out; out=$(./vbc "$1" 2>&1)
    if [ "$out" = "$2" ]; then echo -e "${G}PASS${NC} [$1] => $out"; ((P++))
    else echo -e "${R}FAIL${NC} [$1] => got:'$out' expected:'$2'"; ((F++)); fi
}
E() { c "$1" "Unexpected end of input"; }
T() { c "$1" "Unexpected token '$2'"; }
D() { c "$1" "Division by zero"; }

# --- Single values ---
c '0' '0';   c '1' '1';   c '9' '9';   c '42' '42';  c '100' '100'

# --- Multi-digit ---
c '10+5' '15';  c '12+34' '46';  c '100*2' '200';  c '99-1' '98'
c '20/4' '5';   c '15%4'  '3';   c '100-1' '99'

# --- Basic ops ---
c '1+1' '2';  c '9+1' '10'; c '1*1' '1';   c '2+3' '5'
c '3*4' '12'; c '9*9' '81'; c '0*9' '0';   c '9+0' '9'
c '9-0' '9';  c '9-1' '8';  c '5-3' '2';   c '6/2' '3'
c '9/3' '3';  c '7/2' '3';  c '9%2' '1';   c '8%3' '2'
c '5%5' '0';  c '0/9' '0';  c '0%9' '0';   c '9/9' '1'

# --- Unary ---
c '-1' '-1';   c '-9' '-9';     c '+1' '1';    c '-0' '0'
c '--1' '1';   c '---1' '-1';   c '++1' '1';   c '+-3' '-3'
c '-1+2' '1';  c '1+-2' '-1';   c '1--2' '3';  c '-9+9' '0'
c '1++2' '3';  c '1+2+(+3)' '6'; c '1+2+(-3)' '0'
c '-9*-1' '9'; c '-(3+4)' '-7'; c '-(3+4)*2' '-14'; c '--9' '9'

# --- Power ---
c '2^0'   '1';    c '2^1'  '2';   c '2^10' '1024'
c '3^3'   '27';   c '0^0'  '1';   c '9^2'  '81'
c '(-2)^3' '-8';  c '2^3^2' '512'   # right-assoc: 2^(3^2)=2^9=512
c '(2^3)^2' '64'                    # forced left-assoc via parens

# --- Factorial ---
c '0!' '1';  c '1!' '1';  c '3!' '6';  c '5!' '120'
c '(2+3)!'  '120';  c '-3!' '-6';  c '(3!)' '6'
c '4!'      '24';   c '6!'  '720'

# --- Bitwise ---
c '~0'    '-1';  c '~1'   '-2';  c '~(-1)' '0'
c '5&3'   '1';   c '6&3'  '2';   c '7&5'   '5'
c '5|2'   '7';   c '6|3'  '7';   c '5|0'   '5'
c '7&5|2' '7';   c '~0&5' '5'

# --- Brackets ---
c '[1]'       '1';   c '[1+2]'      '3';    c '[3]*4'     '12'
c '[1+2]*3'   '9';   c '[3+4]*[2+1]' '21';  c '[[1+2]]'   '3'
c '[1+2+3]'   '6';   c '([1+2])'    '3';    c '[(1+2)]'   '3'

# --- Ternary ---
c '1?2:3'        '2';   c '0?2:3'        '3';   c '(1+1)?5:9' '5'
c '0?0:0'        '0';   c '1?1:0'        '1';   c '9?0:1'     '0'
c '0?0:1?2:3'    '2';   c '1?0?9:8:7'    '8'    # nested right-assoc
c '(1?2:3)+1'    '3';   c '1?(2+3):0'    '5';   c '0?9:(2+3)' '5'
c '(3>0)?1:0' "Unexpected token '>'"

# --- Precedence mix ---
c '3*4+5' '17';   c '3+4*5' '23';    c '2+3*4+5' '19'
c '2*3+4*5' '26'; c '1+2*3+4*5+6' '33'
c '8/2+1' '5';    c '8/2*2' '8';     c '9-3-2' '4'
c '9%4+1' '2';    c '2+9%4' '3';     c '6/2/1' '3'
c '2^3*2' '16';   c '2*2^3' '16';    c '1+2^3' '9'
c '2^3+1' '9';    c '(2+1)^2' '9';   c '2^(1+2)' '8'
c '~1+3'  '1';    c '5&3+1' '4'     # + binds tighter than &: 5&(3+1)=5&4=4
                                       # so 5&(3+1)=5&4=4... let me check

# --- Deep nesting ---
c '(((((((3)))))))' '3';   c '[[[3]]]' '3';   c '([([1+2])])' '3'
c '(((((3+2)*2)+1)*2)+1)' '23';  c '((((1+2))*3)*4)*5' '180'
c '(1+(2+(3+(4+(5)))))' '15';    c '1*(2+3*(4+5*(6+7)))' '209'
c '((2+3)*((4+5)*(6+7)))' '585'
c '(((((2+2)*2+2)*2+2)*2+2)*2+2)*2' '188'
c '((6*6+7+5+8)*(1+0+4*8+7)+2)+4*(1+2)' '2254'

# --- Zero/identity ---
c '9*9*0*9*9' '0';  c '(9+9)*0' '0';  c '0*0*0*0*0' '0'
c '1*1*1*1*1*1*1*1*1*1' '1';  c '0+0+0+0+0+0+0+0+0+0' '0'

# --- Large ---
c '9*9*9*9*9*9*9*9*9*9' '3486784401'
c '1+2+3+4+5+6+7+8+9+0' '45';   c '1*2*3*4*5*6*7*8*9*0' '0'
c '2*4+9+3+2*1+5+1+6+6*1*1+8*0+0+5+0*4*9*5*8+9*7+5*1+3+1+4*5*7*3+0*3+4*8+8+8+4*0*5*3+5+4+5*7+9+6*6+7+9*2*6*9+2+1*3*7*1*1*5+1+2+7+4+3*4*2+0+4*4*2*2+6+7*5+9+0+8*4+6*7+5+4*4+2+5*5+1+6+3*5*9*9+7*4*3+7+4*9+3+0+1*8+1+2*9*4*5*1+0*1*9+5*3*5+9*6+5*4+5+5*8*6*4*9*2+0+0+1*5*3+6*8*0+0+2*3+7*5*6+8+6*6+9+3+7+0*0+5+2*8+2*7*2+3+9*1*4*8*7*9+2*0+1*6*4*2+8*8*3*1+8+2*4+8*3+8*3+9*5+2*3+9*5*6*4+3*6*6+7+4*8+0+2+9*8*0*6*8*1*2*7+0*5+6*5+0*2+7+2+3+8*7+6+1*3+5+4*5*4*6*1+4*7+9*0+4+9*8+7+5+6+2+6+1+1+1*6*0*9+7+6*2+4*4+1*6*2*9+3+0+0*1*8+4+6*2+6+2*7+7+0*9+6+2*1+6*5*2*3*5*2*6*4+2*9*2*4*5*2*2*3+8+8*3*2*3+0*5+9*6+8+3*1+6*9+8+9*2*0+2' '94305'

# --- Division by zero ---
D '1/0';  D '1%0';  D '(1+2)/0';  D '9%(1-1)';  D '0/0'

# --- Special errors ---
c '2^-1'   'Negative exponent';  c '(-1)^2' '1'
c '-1!'    '-1';  c '(-3)!'  'Negative factorial'

# --- Unexpected token ---
T '1+2)'   ')';  T '1+2)('  ')';  T '((1+2)*3))' ')'
T 'abc'    'a';  T '1**2'   '*';  T '(*1+2)'     '*'
T '*1'     '*';  T '()'     ')';  T '1+()'       ')'
T '(()' ')';  T '1+2()'  '(';  T '1+2(+3)'    '('
E '((1+3)*12+(3*(2+6))'
T '1+2+3a' 'a';  T '(1+2)3' '3'; T '3(1+2)' '('
T '1+2+3+4+5)' ')';  T '[]' ']';  T '[1+2)' ')'
E '1?2'   # missing : branch - wait let me check
T '1?:2'   ':';  T '?1:2'   '?'

# --- Unexpected end of input ---
E '';     E '1+';    E '1+2*';  E '1+2+';  E '((1+2)*3'
E '(1+2'; E '1+(2+3'; E '(((((2+2)*2+2)*2+2)*2+2)*2'
E '1*';   E '(';     E '((';    E '[';     E '[1+2'
E '(1+';  E '1+(2*';  E '(1+2)*('; E '1+2+(3+4'
E '-';    E '1+-';   E '(-';    E '2^';    E '1?2:'
E '~';    E '1&';    E '1|'

echo -e "\n${G}$P passed${NC} ${R}$F failed${NC} / $((P+F)) total"